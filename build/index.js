(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=require("regenerator-runtime");var r=e.n(t);const n=require("express");var s=e.n(n);const a=require("mongoose");var o=e.n(a),c=process.env,u=c.PORT,i=void 0===u?3e3:u,d=c.KEY,l=void 0===d?"0":d,f="production",p=c.BASE_URL,h=c.HOME_URL,v=c.DB_URI,k=void 0===v?"mongodb://localhost:27017/links":v;const x=require("helmet");var m=e.n(x);var y=new(o().Schema)({full:{type:String,required:!0},short:{type:String,required:!0,default:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:8,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",r="",n=0;n<e;n++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}()},clicks:{type:Number,required:!0,default:0}});const b=o().model("links",y);function w(e,t,r,n,s,a,o){try{var c=e[a](o),u=c.value}catch(e){return void r(e)}c.done?t(u):Promise.resolve(u).then(n,s)}function g(e){return function(){var t=this,r=arguments;return new Promise((function(n,s){var a=e.apply(t,r);function o(e){w(a,n,s,o,c,"next",e)}function c(e){w(a,n,s,o,c,"throw",e)}o(void 0)}))}}function P(){return(P=g(r().mark((function e(){var t;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=s()(),e.next=3,o().connect(k);case 3:t.use(m()()),t.use(n.urlencoded({extended:!1})),t.get("/",(function(e,t){t.status(302).redirect("".concat(h))})),t.get("/:short",g(r().mark((function e(t,n){var s;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,b.findOne({short:t.params.short});case 2:if(s=e.sent){e.next=6;break}return n.status(404).redirect("".concat(h)),e.abrupt("return");case 6:s.clicks++,s.save(),n.status(302).redirect(s.full);case 8:case"end":return e.stop()}}),e)})))),t.post("/create-short",g(r().mark((function e(t,n){var s,a;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.headers["x-api-key"]===l){e.next=5;break}return n.status(401).send("Invalid API key"),e.abrupt("return");case 5:if(!t.body.short){e.next=12;break}return e.next=8,b.create({full:t.body.full,short:t.body.short});case 8:s=e.sent,n.status(200).send("Created: "+s),e.next=16;break;case 12:return e.next=14,b.create({full:t.body.full});case 14:a=e.sent,n.status(200).send("Created: "+a);case 16:case"end":return e.stop()}}),e)})))),t.post("/:short",g(r().mark((function e(t,n){var s;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.headers["x-api-key"]===l){e.next=5;break}return n.status(401).send("Invalid API key"),e.abrupt("return");case 5:return e.next=7,b.findOne({short:t.params.short});case 7:s=e.sent,n.status(200).send({full:s.full,short:"".concat(p,"/").concat(s.short),clicks:s.clicks});case 9:case"end":return e.stop()}}),e)})))),t.post("/remove/:short",g(r().mark((function e(t,n){return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.headers["x-api-key"]===l){e.next=5;break}return n.status(401).send("Invalid API key"),e.abrupt("return");case 5:return e.next=7,b.deleteOne({short:t.params.short});case 7:n.status(200).send("Deleted: ".concat(t.params.short));case 8:case"end":return e.stop()}}),e)})))),t.post("/",g(r().mark((function e(t,n){var s;return r().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.headers["x-api-key"]===l){e.next=5;break}return n.status(401).send("Invalid API key"),e.abrupt("return");case 5:return e.next=7,b.find();case 7:s=e.sent,n.status(200).send("".concat(s));case 9:case"end":return e.stop()}}),e)})))),console.log("Connected to MongoDB"),t.listen({port:i},(function(){console.log("ðŸš€ Server ready at http://localhost:".concat(i)),console.info("NODE_ENV: ".concat(f,", KEY: ").concat(l))}));case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}"0"===l?console.error("Running in production mode with KEY set to 0. Please set KEY to a valid value then start again."):function(){P.apply(this,arguments)}()})();